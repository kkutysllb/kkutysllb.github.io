<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="为了让大家更好理解存储虚拟化的特点，本文将讲解各个常用RAID技术方案的特性，并通过实际部署软RAID 10、RAID 5+备份盘等方案来更直观地体验RAID的效果，以便进一步了解生产环境对硬盘设备的IO读写速度和数据冗余备份机制的需求。同时，本文还将介绍LVM的部署、扩容、缩小、快照以及卸载删除的相关知识，以便让大家通过开源存储虚拟化基础对存储虚拟化的块级虚拟化和文件系统级虚拟化有个更深刻的理解">
<meta name="keywords" content="电信云">
<meta property="og:type" content="article">
<meta property="og:title" content="2019-06-09-Linux原生的存储虚拟化软RAID和LVM">
<meta property="og:url" content="https://kkutysllb.cn/2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/index.html">
<meta property="og:site_name" content="一花一菩提，一云一世界">
<meta property="og:description" content="为了让大家更好理解存储虚拟化的特点，本文将讲解各个常用RAID技术方案的特性，并通过实际部署软RAID 10、RAID 5+备份盘等方案来更直观地体验RAID的效果，以便进一步了解生产环境对硬盘设备的IO读写速度和数据冗余备份机制的需求。同时，本文还将介绍LVM的部署、扩容、缩小、快照以及卸载删除的相关知识，以便让大家通过开源存储虚拟化基础对存储虚拟化的块级虚拟化和文件系统级虚拟化有个更深刻的理解">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdaae3092b89150.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdad639e1883289.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdb033aa6557058.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdb2c9c17861030.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdb527467110620.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdb8e3f83772882.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdbac4614d91015.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdbd591c9b84222.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdbfae058d26478.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdc2bd733957285.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdc63ca58f65011.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdd3b93e4e31750.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdd99db98b69860.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcddb71503b81495.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcddf37dc5749392.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcde4c1c21492447.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcde683820748137.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcde8ba6e8e38978.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcded42d81c26718.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdf114a77617673.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdf41673aa85499.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdf6d9e48941077.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdfa428bd573707.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdfd71812b75693.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfcdff11e04972825.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce0329b51717664.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce086abf0d11068.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce0b432b0b25609.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce0f2b64cb41781.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce149ce3fb31332.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce16a065f755843.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce1827171255801.jpg">
<meta property="og:image" content="https://i.loli.net/2019/06/09/5cfce1bb34a0084086.jpg">
<meta property="og:updated_time" content="2019-06-09T10:39:12.805Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019-06-09-Linux原生的存储虚拟化软RAID和LVM">
<meta name="twitter:description" content="为了让大家更好理解存储虚拟化的特点，本文将讲解各个常用RAID技术方案的特性，并通过实际部署软RAID 10、RAID 5+备份盘等方案来更直观地体验RAID的效果，以便进一步了解生产环境对硬盘设备的IO读写速度和数据冗余备份机制的需求。同时，本文还将介绍LVM的部署、扩容、缩小、快照以及卸载删除的相关知识，以便让大家通过开源存储虚拟化基础对存储虚拟化的块级虚拟化和文件系统级虚拟化有个更深刻的理解">
<meta name="twitter:image" content="https://i.loli.net/2019/06/09/5cfcdaae3092b89150.jpg">



  <link rel="alternate" href="/atom.xml" title="一花一菩提，一云一世界" type="application/atom+xml">




  <link rel="canonical" href="https://kkutysllb.cn/2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>2019-06-09-Linux原生的存储虚拟化软RAID和LVM | 一花一菩提，一云一世界</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?45d7282259ecad100b2fe7e379853e80";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一花一菩提，一云一世界</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">佛系ICT人士技术博客</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kkutysllb.cn/2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kkutysllb">
      <meta itemprop="description" content="容易走的路是下坡路<br>总是不经意间装个X得罪一票人">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一花一菩提，一云一世界">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">2019-06-09-Linux原生的存储虚拟化软RAID和LVM

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-09 18:06:49 / 修改时间：18:39:12" itemprop="dateCreated datePublished" datetime="2019-06-09T18:06:49+08:00">2019-06-09</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NFV关键技术/" itemprop="url" rel="index"><span itemprop="name">NFV关键技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">22k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">20 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>为了让大家更好理解存储虚拟化的特点，本文将讲解各个常用RAID技术方案的特性，并通过实际部署软RAID 10、RAID 5+备份盘等方案来更直观地体验RAID的效果，以便进一步了解生产环境对硬盘设备的IO读写速度和数据冗余备份机制的需求。同时，本文还将介绍LVM的部署、扩容、缩小、快照以及卸载删除的相关知识，以便让大家通过开源存储虚拟化基础对存储虚拟化的块级虚拟化和文件系统级虚拟化有个更深刻的理解。<a id="more"></a></p>
<h2 id="RAID-技术"><a href="#RAID-技术" class="headerlink" title="RAID 技术"></a>RAID 技术</h2><p>这里主要介绍开源RAID技术，至于华为的RAID2.0技术详见存储虚拟化其他文章。<strong>RAID技术通过把多个硬盘设备组合成一个容量更大、安全性更好的磁盘阵列，并把数据切割成多个区段后分别存放在各个不同的物理硬盘设备上，然后利用分散读写技术来提升磁盘阵列整体的性能，同时把多个重要数据的副本同步到不同的物理硬盘设备上，从而起到了非常好的数据冗余备份效果。</strong></p>
<p>RAID技术的设计初衷是减少因为采购硬盘设备带来的费用支出，但是与数据本身的价值相比较，现代企业更看重的则是RAID技术所具备的冗余备份机制以及带来的硬盘吞吐量的提升。RAID技术的几种状态如下图所示：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdaae3092b89150.jpg"></p>
<p><strong>RAID组变为降级状态后，在重建的过程中，如果还有别的成员盘出现故障，故障的成员盘的个数超过了阵列的冗余磁盘的个数，整个RAID组将为变为失效状态，此时原RAID组中的数据将会无法读取。</strong></p>
<h3 id="RAID-0"><a href="#RAID-0" class="headerlink" title="RAID 0"></a>RAID 0</h3><p><strong>RAID 0技术把多块物理硬盘设备（至少两块）通过硬件或软件的方式串联在一起，组成一个大的卷组，并将数据依次写入到各个物理硬盘中。</strong>在最理想的状态下，<strong>硬盘设备的读写性能会提升数倍</strong>，但是若任意一块硬盘发生故障将导致整个系统的数据都受到破坏。也就说，<strong>RAID 0技术能有效提升硬盘数据的吞吐率，但不具备数据备份和错误修复能力。</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdad639e1883289.jpg"></p>
<p>如上图，RAID 0使用<strong>“分条”（stripe）技术</strong>把数据分布到各个磁盘上，RAID 0至少使用两个磁盘，<strong>并将数据分成从512字节到数兆字节（一般是512Byte的整数倍）的若干块</strong>，这些数据块可以并行写到不同的磁盘中。第1块数据被写到驱动器1中，第2块数据被写到驱动器2中，如此类推，当系统到达阵列中的最后一个磁盘时，就重新回到驱动器1的下一分条进行写操作，分割数据将I/O负载平均分配到所有的驱动器。</p>
<p><strong>RAID 0的数据写入是以分条形式将数据均匀分布到RAID 组的各个硬盘中。</strong>即一个分条的所有分块写满后，再开始在下一个分条上进行数据写入。如上图，现在有数据D0 ，D1 ，D2 ，D3 ，D4 ，D5需要在RAID 0中进行写入，首先将第一个数据D0写入第一块硬盘位于第一个分条的块，将第二个数据D1写入第二块硬盘位于第一个分条的块，至此，第一个分条的各个块写满了数据，当有数据D2需要写入时，就要对下一个分条进行写入，将数据D2写入第一块硬盘位于第二个分条的块中… 数据块D3，D4，D5的写入同理。<strong>写满一个分条的所有块再开始在下一个分条中进行写入。</strong></p>
<p><strong>RAID 0在收到数据读取指令后，就会在各个硬盘中进行搜索，看需要读取的数据块位于哪一个硬盘上，再依次对需要读取的数据进行读取。</strong>如上图，现在收到读取数据D0 ，D1 ，D2 ，D3 ，D4 ，D5的指令，首先从第一块磁盘读取数据块D0，再从第二块磁盘读取数据块D1…对各个数据块，从磁盘阵列读取后再由RAID控制器进行整合后传送给系统。至此，整个读取过程结束。</p>
<h3 id="RAID-1"><a href="#RAID-1" class="headerlink" title="RAID 1"></a>RAID 1</h3><p>RAID 1技术是把<strong>两块以上</strong>的硬盘进行绑定，在写入数据时，是将数据同时写入到多块硬盘设备上，其中某一块硬盘用作数据的备份或镜像。当其中某一块硬盘发生故障后，一般会自动切换的方式来恢复数据的正常使用。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdb033aa6557058.jpg"></p>
<p><strong>如上图，RAID 1也被称为镜像，其目的是为了打造出一个安全性极高的RAID。</strong>RAID 1使用两组相同的磁盘系统互作镜像，速度没有提高，但是允许单个磁盘故障，数据可靠性最高。其原理为在主硬盘上存放数据的同时也在镜像硬盘上写一样的数据。当主硬盘（物理）损坏时，镜像硬盘则代替主硬盘的工作。因为有镜像硬盘做数据备份，所以RAID 1的数据安全性在所有的RAID级别上来说是最好的。</p>
<p><strong>RAID 1在进行数据写入的时候，并不是像RAID 0那样将数据分条写入所有磁盘，而是将数据分别写入成员盘，各个成员磁盘上的数据完全相同，互为镜像。</strong>如上图，需要将数据块D0，D1，D2写入RAID 1，先在两个磁盘上同时写入数据块D0，再在两个磁盘上同时写入数据块D1，以此类推。</p>
<p><strong>RAID 1在进行数据读取的时候，正常情况下可以实现数据盘和镜像盘同时读取数据，提高读取性能，如果一个磁盘损坏，则IO自动到存活的盘读取数据。</strong></p>
<p><strong>RAID 1的成员磁盘是互为镜像的，成员磁盘的内容完全相同，这样，任何一组磁盘中的数据出现问题，都可以马上从其它成员磁盘进行镜像恢复。</strong>比如：磁盘1损坏导致数据丢失，我们需要将故障磁盘用正常磁盘替换，再读取磁盘2的数据，将其复制到磁盘1上，从而实现了数据的恢复。</p>
<h3 id="RAID-3"><a href="#RAID-3" class="headerlink" title="RAID 3"></a>RAID 3</h3><p><strong>RAID 3是带有专用奇偶位的条带化阵列，是RAID 0的一种改进模式。它也采用了奇偶校验技术，不过没有使用海明码技术而采用较为简单的异或算法。</strong>在阵列中有一个驱动器专门用来保存其它驱动器中对应分条中数据的奇偶校验信息。奇偶位是编码信息，如果某个驱动器中的数据出错或者某一个驱动器故障，可以通过对奇偶校验信息的计算来恢复出故障驱动器中的数据信息。在数据密集型环境或者是单一用户环境中，组建RAID 3对访问较长的连续记录较好。在写入数据时，RAID 3会把数据的写入操作分散到多个磁盘上进行，然而不管是向哪一个数据盘写入数据，都需要同时重写校验盘中的相关信息。因此，对于那些经常需要执行大量写入操作的应用来说，校验盘的负载将会很大，无法满足程序的运行速度，从而导致整个RAID系统性能的下降。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdb2c9c17861030.jpg"></p>
<p><strong>RAID 3是单盘容错并行传输。即采用Stripping技术将数据分块</strong>，对这些块进行异或校验，校验数据写到最后一个硬盘上。它的特点是有一个盘为校验盘，数据以位或字节的方式存于各盘（分散记录在组内相同扇区的各个硬盘上）。当一个硬盘发生故障，除故障盘外，写操作将继续对数据盘和校验盘进行操作。</p>
<p><strong>RAID3的数据读取是按照分条来进行的。</strong>将每个磁盘的驱动器主轴马达做精确的控制，同一分条上各个磁盘上的数据位同时读取，各个驱动器得到充分利用，读性能较高。 <strong>RAID 3的数据读写属于并行方式。</strong></p>
<p><strong>RAID 3的数据恢复是通过对剩余数据盘和校验盘的异或计算重构故障盘上应有的数据来进行的。</strong>如上图的RAID 3磁盘结构，当磁盘2故障，其上存储的数据位A1，B1，C1丢失，我们需要经过这样一个数据恢复过程：首先恢复数据A1，根据同一分条上其它数据盘和校验盘上的数据A0，A2，P1，进行异或运算，得到应有的数据A1，再用相同方法恢复出数据B1，C1的数据，至此，磁盘2上的数据全部得到了恢复。<strong>由于校验集中在一个盘，因此在数据恢复时，校验盘写压力比较大，影响性能。</strong></p>
<h3 id="RAID-5"><a href="#RAID-5" class="headerlink" title="RAID 5"></a>RAID 5</h3><p><strong>RAID5是一种旋转奇偶校验独立存取的阵列方式，它与RAID3不同的是没有固定的校验盘，</strong>而是按某种规则把奇偶校验信息均匀地分布在阵列所属的硬盘上，所以在每块硬盘上，既有数据信息也有校验信息。这一改变解决了争用校验盘的问题，能并发进行多个写操作。所以RAID 5即适用于大数据量的操作，也适用于各种事务处理，它是一种快速、大容量和容错分布合理的磁盘阵列。当有N块阵列盘时，可用容量为N-1块盘容量。 <strong>RAID 3、RAID 5中，在一块硬盘发生故障后，RAID组从ONLINE变为DEGRADED方式，直到故障盘恢复。但如果在DEGRADED状态下，又有第二块盘故障，整个RAID组的数据将丢失。</strong> </p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdb527467110620.jpg"></p>
<p><strong>RAID 5的数据写入也是按分条进行的，各个磁盘上既存储数据块，又存储校验信息。</strong>一个分条上的数据块写入完成后，将产生的校验信息写入对应的校验磁盘中。<strong>由于RAID 5的数据是按照数据分条存储的，在读取的时候，按照分条进行读取。</strong></p>
<p>当RAID5中某一个磁盘故障，在恢复的时候，可利用其它存活成员盘数据进行异或逆运算，恢复故障盘上的数据。</p>
<h3 id="RAID-6"><a href="#RAID-6" class="headerlink" title="RAID 6"></a>RAID 6</h3><p><strong>RAID 6是带有两种校验的独立磁盘结构，采用两种奇偶校验方法，需要至少N+2(N&gt;2)个磁盘来构成阵列</strong>，一般用在数据可靠性、可用性要求极高的应用场合 。常用的RAID 6技术有<strong>RAID6 P＋Q</strong>和<strong>RAID6 DP。</strong></p>
<p>RAID 6实际上是在RAID 5基础上为了进一步保证数据可用性和可靠性设计的一种RAID方式。与<strong>RAID 5相比除了有通常的异或校验方式外，还增加了另一种特殊的异或校验方式和该方式校验数据存放区域</strong>，因此RAID 6的数据冗余性能相当好。但是，由于增加了一个校验，所以写入的效率比RAID 5要低，而且控制系统的设计也更为复杂，第二个校验区也减少了有效存储空间。</p>
<p>目前RAID 6还没有统一的标准，各家公司的实现方式都有所不同，主要有以下两种方式：</p>
<ul>
<li><strong>RAID P+Q： 华为、HDS</strong></li>
<li><strong>RAID DP： NetApp</strong></li>
</ul>
<p><strong>两种技术获取校验信息的方法不同，但是都能够在两块成员盘故障的情况下读取数据，数据不丢失。</strong></p>
<p><strong>1）RAID6 P＋Q的工作原理</strong></p>
<p>RAID6 P＋Q需要计算出两个校验数据P和Q，当有两个数据丢失时，根据P和Q恢复出丢失的数据。校验数据P和Q是由以下公式计算得来的：</p>
<p>​     <strong>P=D0⊕ D1 ⊕ D2 ……</strong>      </p>
<p>​     <strong>Q=(α⊗D0)⊕(β⊗D1)⊕(γ⊗D2)……</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdb8e3f83772882.jpg"></p>
<p>在RAID6 P＋Q中，<strong>P和Q是两个相互独立的校验值，它们的计算互不影响，都是由同一分条上其它数据磁盘上的数据依据不同的算法计算而来的。</strong></p>
<p><strong>其中，P值的获得是通过同一分条上除P和Q之外的其它所有数据盘上数据的简单异或运算得到。Q值的获得过程就相对复杂一些，它首先对同一分条其他磁盘上的各个数据分别进行一个变换，然后再将这些变换结果进行异或操作而得到校验盘上的数据。</strong>这个变换被称为<strong>GF变换</strong>，它是一种常用的数学变换方法，可以通过查GF变换表而得到相应的变换系数，再将各个磁盘上的数据与变换系数进行运算就得到了GF变换后的数据，这个变换过程是由RAID控制器来完成的。</p>
<p>以上图为例，P1是由分条0中的数据D0、D1、D2进行简单的异或运算而得到的。同理，P2是由分条1中的数据D3、D4、D5进行简单的异或运算而得到， P3是由分条2中的数据D6、D7、D8进行简单的异或运算而得到。Q1是由分条0中的数据D0、D1、D2分别进行GF变换之后再进行异或运算而得到的。同理，Q2是由分条1中的数据D3、D4、D5分别进行GF变换之后再进行异或运算而得到， Q3是由分条2中的数据D6、D7、D8分别进行GF变换之后再进行异或运算而得到。</p>
<p>当某一个分条中有一块磁盘发生故障，根本不需要Q，直接用校验值P与其他正常数据进行异或运算就可以恢复出故障盘上面的数据，数据恢复比较方便。当分条中有两块磁盘发生故障，如果其中包含Q所在的磁盘，则可以先恢复出数据盘上面的数据，再恢复出校验盘Q上的校验值；如果故障盘不包含Q所在的盘，则可以将两个校验公式作为方程组，从而可以恢复出两个故障盘上面的数据。</p>
<p><strong>2）RAID6 DP的工作原理</strong></p>
<p>DP就是Double Parity，就是在RAID4所使用的一个行XOR校验磁盘的基础上又增加了一个磁盘用于存放斜向的XOR校验信息。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdbac4614d91015.jpg"></p>
<p>横向校验盘中P0—P3为各个数据盘中横向数据的校验信息。比如：P0=D0  XOR D1 XOR D2 XOR D3。斜向校验盘中DP0—DP3为各个数据盘及横向校验盘的斜向数据校验信息。比如：DP0=D0 XOR D5 XOR D10 XOR D15</p>
<p><strong>RAID6 DP 同样也有两个相互独立的校验信息块，但是与RAID6 P＋Q 不同的是，它的第二块校验信息是斜向的。横向校验信息和斜向校验信息都使用异或校验算法而得到，</strong>横向校验盘中的信息的获得方法非常简单：P0是由条带0中的数据D0、D1、D2、 D3进行简单的异或运算而得到的。同理， P1是由分条1中的数据D4、D5、D6、D7进行简单的异或运算而得到。</p>
<p>斜向校验盘中校验信息的获得依然是采用数据之间的异或运算，只是数据块的选取相对复杂一些，是一个斜向的选取过程：由分条0上面第一个磁盘上的数据D0、分条1上面第二个磁盘上的数据D5、分条2上面第三个磁盘上的数据D10、分条3上面第四个磁盘上的数据D15经过异或校验而得到校验信息DP0；由分条0上面第二个磁盘上的数据D1、分条1上面第三个磁盘上的数据D6、分条2上面第四个磁盘上的数据D11、分条3上面校验盘上面的信息P3经过异或校验而得到校验信息DP1；由分条0上面第三个磁盘上的数据D2、分条1上面第四个磁盘上的数据D7、分条2上面校验盘上面的信息P2、分条3上面第一个磁盘上的数据D12经过异或校验而得到校验信息DP2。</p>
<p><strong>RAID6 DP允许阵列中同时有两个磁盘失效</strong>，我们以上图为例，假设磁盘1、2故障，则数据D0、D1、D4、D5、D8、D9、D12、D13失效，其他磁盘数据和校验信息正常。我们来看一下数据恢复是怎样一个过程：首先根据DP2和斜向校验恢复出D12， D12 =D2 ⊕ D7 ⊕ P2 ⊕DP2，然后利用P3和横向校验恢复出D13， D13 =D12 ⊕ D14 ⊕ D15 ⊕P3 ；根据DP3斜向校验恢复出D8， D8 =D3 ⊕ P1 ⊕DP3 ⊕ D13，利用P2和横向校验恢复出D9， D9 =D8 ⊕ D10 ⊕ D11 ⊕ P2；根据DP4和斜向校验恢复出D4，利用P1和横向校验恢复出D5，以此类推进而恢复出磁盘1、2上的所有数据。</p>
<h3 id="RAID-10"><a href="#RAID-10" class="headerlink" title="RAID 10"></a>RAID 10</h3><p>RAID 10是将镜像和条带进行组合的RAID级别，先进行RAID 1镜像然后再做RAID  0。RAID 10也是一种应用比较广泛的RAID级别。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdbd591c9b84222.jpg"></p>
<p>RAID 10集RAID 0和RAID 1的优点于一身，适合应用在速度和容错要求都比较高的场合。先进行镜像，再进行分条。物理磁盘1和物理磁盘2组成RAID 1，物理磁盘3和物理磁盘4组成RAID 1，两个RAID 1再进行RAID 0。 </p>
<p>当不同RAID1中的磁盘，如物理磁盘2和物理磁盘4发生故障导致数据失效时，整个阵列的数据读取不会受到影响，因为物理磁盘1和物理磁盘3上面已经保存了一份完整的数据。但是如果组成RAID 1的磁盘（如物理磁盘1和物理磁盘2）同时故障，数据将不能正常读取。</p>
<h3 id="RAID-50"><a href="#RAID-50" class="headerlink" title="RAID 50"></a>RAID 50</h3><p>RAID 50是将RAID 5和RAID 0进行两级组合的RAID级别，第一级是 RAID 5，第二级为RAID 0。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdbfae058d26478.jpg"></p>
<p>RAID 50是RAID 5和RAID 0的结合，先将3个或3个以上磁盘实现RAID 5，再把若干个RAID 5进行RAID 0分条。 RAID 50需要至少6个磁盘构成，把数据分条后分放到各个RAID 5中，在RAID 5中再进行分条和计算校验值及校验值的分布式存储。</p>
<p>如上图，物理磁盘1、2、3实现RAID 5，物理磁盘4、5、6实现RAID 5，再将两个RAID 5放在一起进行分条。允许不同RAID 5中的多块磁盘同时失效，但是一旦同一RAID 5中的两块磁盘故障，将会导致阵列失效。</p>
<h3 id="常用RAID级别的比较和应用场景"><a href="#常用RAID级别的比较和应用场景" class="headerlink" title="常用RAID级别的比较和应用场景"></a>常用RAID级别的比较和应用场景</h3><p><img src="https://i.loli.net/2019/06/09/5cfcdc2bd733957285.jpg"></p>
<p><strong>RAID组成员盘个数不建议过多，例如超过20块成员盘的RAID,不但性能比8-9块成员盘RAID组(建议RAID5成员盘个数)低，且在运行过程中RAID组失效的概率增加。</strong></p>
<table>
<thead>
<tr>
<th><strong>RAID级别</strong></th>
<th><strong>RAID 0</strong></th>
<th><strong>RAID 1</strong></th>
<th><strong>RAID 3</strong></th>
<th><strong>RAID 5 /6</strong></th>
<th><strong>RAID 10</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>典型应用环境</td>
<td>迅速读写，安全性要求不高，如图形工作站等</td>
<td>随机数据写入，安全性要求高，如服务器、数据库存储领域</td>
<td>连续数据传输，安全性要求高，如视频编辑、大型数据库等</td>
<td>随机数据传输，安全性要求高，如金融、数据库、存储等</td>
<td>数据量大，安全性要求高，如银行、金融等领域</td>
</tr>
</tbody>
</table>
<h3 id="虚拟机中的RAID实操"><a href="#虚拟机中的RAID实操" class="headerlink" title="虚拟机中的RAID实操"></a>虚拟机中的RAID实操</h3><p><strong>由于我们在虚拟机中搭建实验环境，所以采用Linux的软RAID来搭建，与实际生产环境硬件RAID卡相比，除了性能上不达标，一些关键特性不具备外，在数据写入、读取和恢复方面的机制类似，便于大家理解RAID的工作特性。</strong></p>
<p>首先我们给虚拟机挂载4块数据盘，用于组建RAID 10，如下图所示：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdc63ca58f65011.jpg"></p>
<p><strong>mdadm命令用于管理Linux系统中的软件RAID硬盘阵列</strong>，格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm [模式]  [选项] [成员设备名称]</span><br></pre></td></tr></table></figure>
<p>mdadm命令在Linux系统 中创建和管理软件RAID磁盘阵列，它涉及的理论知识的操作过程与生产环境中的完全一致。mdadm常用命令选项如下：</p>
<p><strong>1）创建模式命令选项和专用选项</strong></p>
<ul>
<li>-C 创建RAID</li>
<li>-l 指定级别</li>
<li>-n 指定设备个数</li>
<li>-v 显示创建过程</li>
<li>-a {yes|no} 自动为其创建设备文件</li>
<li>-c 指定数据块大小（chunk）</li>
<li>-x 指定空闲盘（热备磁盘）个数，空闲盘（热备磁盘）能在工作盘损坏后自动顶替</li>
</ul>
<p><strong>注意：创建阵列时，阵列所需磁盘数为-n参数和-x参数的个数和</strong></p>
<p>下面开始创建RAID过程：</p>
<p><strong>Step1：在系统中，通过mdadm创建一个软RAID 10，命名为/dev/md10，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mdadm -Cv /dev/md10 -a yes -n 4 -l 10 /dev/sdb /dev/sdc /dev/sde /dev/sdd</span></span><br><span class="line">mdadm: layout defaults to n2</span><br><span class="line">mdadm: layout defaults to n2</span><br><span class="line">mdadm: chunk size defaults to 512K</span><br><span class="line">mdadm: size <span class="built_in">set</span> to 20954112K</span><br><span class="line">mdadm: Defaulting to version 1.2 metadata</span><br><span class="line">mdadm: array /dev/md10 started.</span><br><span class="line">[root@c7-test01 ~]<span class="comment"># fdisk -l | grep "/dev/md10"</span></span><br><span class="line">Disk /dev/md10: 42.9 GB, 42914021376 bytes, 83816448 sectors</span><br></pre></td></tr></table></figure>
<p>通过上面的校验我们发现RAID 10创建成功，且大小为42.9G，符合预期。</p>
<p><strong>Step2：将创建好的md10格式化为ext4文件系统</strong>，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mkfs.ext4 /dev/md10</span></span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=128 blocks, Stripe width=256 blocks</span><br><span class="line">2621440 inodes, 10477056 blocks</span><br><span class="line">523852 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=2157969408</span><br><span class="line">320 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, </span><br><span class="line">4096000, 7962624</span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (32768 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><strong>Step3：创建挂载点，把md10设备进行挂载，挂载后就可以发现md10可用空间为40G，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mkdir /home/data</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mount /dev/md10 /home/data</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3        41G  2.4G   37G   7% /</span><br><span class="line">devtmpfs        2.0G     0  2.0G   0% /dev</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs           2.0G   12M  2.0G   1% /run</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1       380M  102M  254M  29% /boot</span><br><span class="line">tmpfs           394M     0  394M   0% /run/user/0</span><br><span class="line">/dev/md10        40G   49M   38G   1% /home/data</span><br></pre></td></tr></table></figure>
<p><strong>Step4：查看/dev/md10磁盘阵列的详细信息，并把挂载信息写入到配置文件中，使其开机即挂载永久生效。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mdadm -D /dev/md10</span></span><br><span class="line">/dev/md10:</span><br><span class="line">           Version : 1.2</span><br><span class="line">     Creation Time : Sun Jun  9 12:52:22 2019</span><br><span class="line">        Raid Level : raid10</span><br><span class="line">        Array Size : 41908224 (39.97 GiB 42.91 GB)</span><br><span class="line">     Used Dev Size : 20954112 (19.98 GiB 21.46 GB)</span><br><span class="line">      Raid Devices : 4</span><br><span class="line">     Total Devices : 4</span><br><span class="line">       Persistence : Superblock is persistent</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">   Update Time : Sun Jun  9 12:59:55 2019</span><br><span class="line">         State : clean </span><br><span class="line">Active Devices : 4</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">   Working Devices : 4</span><br><span class="line">    Failed Devices : 0</span><br><span class="line">     Spare Devices : 0</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">        Layout : near=2</span><br><span class="line">    Chunk Size : 512K</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">Consistency Policy : resync</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">          Name : c7-test01:10  (<span class="built_in">local</span> to host c7-test01)</span><br><span class="line">          UUID : 7f68ffce:e80f0c04:6c58f40c:526c5508</span><br><span class="line">        Events : 17</span><br><span class="line"></span><br><span class="line">Number   Major   Minor   RaidDevice State</span><br><span class="line">   0       8       16        0      active sync <span class="built_in">set</span>-A   /dev/sdb</span><br><span class="line">   1       8       32        1      active sync <span class="built_in">set</span>-B   /dev/sdc</span><br><span class="line">   2       8       64        2      active sync <span class="built_in">set</span>-A   /dev/sde</span><br><span class="line">   3       8       48        3      active sync <span class="built_in">set</span>-B   /dev/sdd</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># echo "/dev/md10 /home/data ext4 defaults 0 0" &gt;&gt; /etc/fstab</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># cat /etc/fstab </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Created by anaconda on Sat Jun  1 20:49:28 2019</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Accessible filesystems, by reference, are maintained under '/dev/disk'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">UUID=f078e329-6693-4fdd-89ad-0d5734b5e35f /                       ext4    defaults        1 1</span><br><span class="line">UUID=13919904-2c90-429c-b5ea-56f823a6e87c /boot                   ext4    defaults        1 2</span><br><span class="line">UUID=d3b139fc-7730-4bee-886b-1d4e0d681bae swap                    swap    defaults        0 0</span><br><span class="line">/dev/md10 /home/data ext4 defaults 0 0</span><br></pre></td></tr></table></figure>
<p><strong>2）管理模式</strong></p>
<ul>
<li>-a(–add)：添加磁盘</li>
<li>-d(–del)：删除磁盘</li>
<li>-r(–remove)：从RAID中移除损坏的成员盘</li>
<li>-f(–fail)：模拟成员盘故障</li>
<li>-S：停止阵列工作</li>
</ul>
<p><strong>注意：新增加的硬盘需要与原硬盘大小一致，且如果原有阵列缺少工作磁盘（如raid1只有一块在工作，raid5只有2块在工作），这时新增加的磁盘直接变为工作磁盘，如果原有阵列工作正常，则新增加的磁盘为热备磁盘。</strong></p>
<p><strong>Step1：模拟成员盘/dev/sdb故障，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mdadm /dev/md10 -f /dev/sdb</span></span><br><span class="line">mdadm: <span class="built_in">set</span> /dev/sdb faulty <span class="keyword">in</span> /dev/md10</span><br></pre></td></tr></table></figure>
<p><strong>Step2：查看RAID状态，此时md10仍正常工作，但出于降级状态，符合预期。</strong>如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdd3b93e4e31750.jpg"></p>
<p>在RAID 10级别的磁盘阵列中，当RAID 1磁盘阵列中存在一个故障盘时并不影响RAID 10磁盘阵列的使用，但是磁盘阵列此时出于降级使用状态。当购买了新的硬盘设备后再使用mdadm命令来予以替换即可，在此期间我们可以在/home/data目录中正常地创建或删除文件。由于我们是在虚拟机中模拟硬盘，所以先重启系统，然后再把新的硬盘添加到RAID磁盘阵列中。这个过程不是我们讨论的重点，现在/dev/sdb成员盘故障，使得md10处于降级使用状态，如果/dev/sdd故障呢？/dev/sdc故障呢？这两点才是我们要重点讨论的地方。</p>
<p><strong>Step3：再次模拟成员/dev/sdd故障，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mdadm /dev/md10 -f /dev/sdd</span></span><br><span class="line">mdadm: <span class="built_in">set</span> /dev/sdd faulty <span class="keyword">in</span> /dev/md10</span><br></pre></td></tr></table></figure>
<p><strong>Step4：再次查看RAID的状态，</strong>如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdd99db98b69860.jpg"></p>
<p>此时阵列中虽然坏了两块成员盘/dev/sdb和/dev/sdd，因为这两块成员盘同属于不同的RAID 1，所以阵列状态仍为降级状态，也就是表示还可以使用。接下来，我们模拟同一个RAID1中两块成员盘故障，看看阵列状态是否能达到我们预期的失效态。在模拟之前，需要先恢复一块成员盘，比如：/dev/sdd。<strong>注意：需要重启系统后才能恢复。恢复磁盘后，需要等待一段时间，此时刚恢复的磁盘正在恢复数据，如下：</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfcddb71503b81495.jpg"></p>
<p><strong>Step5：模拟同一个RAID 1下两块成员盘同时故障，</strong>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]# mdadm /dev/md10 -f /dev/sdb /dev/sdc</span><br><span class="line">mdadm: set /dev/sdb faulty in /dev/md10</span><br><span class="line">mdadm: set /dev/sdc faulty in /dev/md10</span><br></pre></td></tr></table></figure>
<p><strong>Step6：再次查看阵列状态，此时软RAID 10虽然显示状态为降级使用，但是只有SET-A组，也就是说SET-B组的数据已丢失。</strong>如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcddf37dc5749392.jpg"></p>
<p><strong><em>RAID 5 的创建方法与此类似，不过RAID 5至少需要3块硬盘，同时，为了保证数据的可靠性，可以再增加一块热备盘。当成员盘故障时，数据盘可以立即顶上去并做数据同步和恢复操作。</em></strong></p>
<p><strong>Step1：创建RAID 5阵列/dev/md5，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mdadm -Cv /dev/md5 -a yes -n 3 -l 5 -x 1 /dev/sdf /dev/sdg /dev/sdh /dev/sdi</span></span><br><span class="line">mdadm: layout defaults to left-symmetric</span><br><span class="line">mdadm: layout defaults to left-symmetric</span><br><span class="line">mdadm: chunk size defaults to 512K</span><br><span class="line">mdadm: size <span class="built_in">set</span> to 20954112K</span><br><span class="line">mdadm: Defaulting to version 1.2 metadata</span><br><span class="line">mdadm: array /dev/md5 started.</span><br></pre></td></tr></table></figure>
<p><strong>Step2：格式化md5，并创建挂载目录，并挂载磁盘</strong>，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mkfs.ext /dev/md5</span></span><br><span class="line">-bash: mkfs.ext: <span class="built_in">command</span> not found</span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mkfs.ext4 /dev/md5</span></span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=128 blocks, Stripe width=256 blocks</span><br><span class="line">2621440 inodes, 10477056 blocks</span><br><span class="line">523852 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=2157969408</span><br><span class="line">320 block groups</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">8192 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, </span><br><span class="line">	4096000, 7962624</span><br><span class="line"></span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (32768 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span>   </span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mkdir /home/code</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mount /dev/md5 /home/code</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3        41G  2.4G   37G   7% /</span><br><span class="line">devtmpfs        2.0G     0  2.0G   0% /dev</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /dev/shm</span><br><span class="line">tmpfs           2.0G   12M  2.0G   1% /run</span><br><span class="line">tmpfs           2.0G     0  2.0G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1       380M  102M  254M  29% /boot</span><br><span class="line">/dev/md10        40G   49M   38G   1% /home/data</span><br><span class="line">tmpfs           394M     0  394M   0% /run/user/0</span><br><span class="line">/dev/md5         40G   49M   38G   1% /home/code</span><br></pre></td></tr></table></figure>
<p><strong>Step3：查看阵列md5的状态，</strong>如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcde4c1c21492447.jpg"></p>
<p><strong>Step4：我们再次将成员盘/dev/sdf模拟故障，然后可以看见热备盘/dev/sdi自动顶上故障盘位置并开始同步恢复数据。</strong>如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcde683820748137.jpg"></p>
<h2 id="LVM逻辑卷管理"><a href="#LVM逻辑卷管理" class="headerlink" title="LVM逻辑卷管理"></a>LVM逻辑卷管理</h2><h3 id="LVM逻辑卷管理的原理浅析"><a href="#LVM逻辑卷管理的原理浅析" class="headerlink" title="LVM逻辑卷管理的原理浅析"></a>LVM逻辑卷管理的原理浅析</h3><p>LVM是逻辑盘卷管理（Logical Volume Manager）的简称，它是Linux环境下对磁盘分区进行管理的一种机制，LVM是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。</p>
<p><strong>LVM的工作原理其实很简单，它就是通过将底层的物理硬盘抽象的封装起来，然后以逻辑卷的方式呈现给上层应用。</strong>在传统的磁盘管理机制中，我们的上层应用是直接访问文件系统，从而对底层的物理硬盘进行读取，而在LVM中，其通过对底层的硬盘进行封装，当我们对底层的物理硬盘进行操作时，其不再是针对于分区进行操作，而是通过一个叫做逻辑卷的东西来对其进行底层的磁盘管理操作。比如说我增加一个物理硬盘，这个时候上层的服务是感觉不到的，因为呈现给上层服务的是以逻辑卷的方式。</p>
<p><strong>LVM最大的特点就是可以对磁盘进行动态管理。因为逻辑卷的大小是可以动态调整的，而且不会丢失现有的数据。</strong>如果我们新增加了硬盘，其也不会改变现有上层的逻辑卷。作为一个动态磁盘管理机制，逻辑卷技术大大提高了磁盘管理的灵活性。<strong>LVM的最大缺点就是影响磁盘I/O效率。</strong></p>
<p>在一个硬盘上创建多个逻辑卷，对创建好的卷调整大小，然后将它们挂载在’/home,/var,/tmp’等目录下，如下所示：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcde8ba6e8e38978.jpg"></p>
<blockquote>
<p><strong>PV（Physical Volume）- 物理卷：</strong>物理卷在逻辑卷管理中处于最底层，它可以是实际物理硬盘上的分区，也可以是整个物理硬盘，也可以是raid设备，是LVM的基本存储逻辑块，但和基本的物理存储介质(如分区、磁盘等)比较，却包含有与LVM相关的管理参数。</p>
<p><strong>VG（Volumne Group）- 卷组：</strong>卷组建立在物理卷之上，一个卷组中至少要包括一个物理卷，在卷组建立之后可动态添加物理卷到卷组中。一个逻辑卷管理系统工程中可以只有一个卷组，也可以拥有多个卷组。</p>
<p><strong>PE（physical extent）：</strong>每一个物理卷被划分为称为PE(Physical Extents)的基本单元，具有唯一编号的PE是可以被LVM寻址的最小单元。PE的大小是在VG过程中配置的，默认为4MB。</p>
<p>LVM 默认使用4MB的PE区块，而LVM的LV最多仅能含有65534个PE (lvm1 的格式)，因此默认的LVM的LV最大容量为4M*65534/(1024M/G)=256G。PE是整个LVM 最小的储存区块，也就是说，其实我们的资料都是由写入PE 来处理的。简单的说，这个PE 就有点像文件系统里面的block 角色。所以调整PE 会影响到LVM 的最大容量！不过，在 CentOS 6.x 以后，由于直接使用 lvm2 的各项格式功能，因此这个限制已经不存在了。</p>
<p><strong>LV（Logical Volume）- 逻辑卷</strong>：逻辑卷建立在卷组之上，卷组中的未分配空间可以用于建立新的逻辑卷，逻辑卷建立后可以动态地扩展和缩小空间。系统中的多个逻辑卷可以属于同一个卷组，也可以属于不同的多个卷组。</p>
</blockquote>
<p><strong><em>简单来说就是：PV是物理的存储设备（整块磁盘或磁盘分区），VG是一个存放PV的仓库，将仓库中所有PV重新编号，也就是PE。LV就是用重新编号的PE组成的逻辑磁盘。</em></strong></p>
<p><strong>LVM 主要有三类命令行工具：</strong></p>
<ul>
<li><strong>pv 开头的命令用来操作 PV 物理卷</strong></li>
<li><strong>vg 开头的命令用来操作 VG 逻辑卷组</strong></li>
<li><strong>lv 开头的命令用来操作 LV 逻辑卷</strong></li>
</ul>
<table>
<thead>
<tr>
<th>功能/命令</th>
<th>物理卷管理</th>
<th>卷组管理</th>
<th>逻辑卷管理</th>
</tr>
</thead>
<tbody>
<tr>
<td>扫描</td>
<td>pvscan</td>
<td>vgscan</td>
<td>lvscan</td>
</tr>
<tr>
<td>建立</td>
<td>pvcreate</td>
<td>vgcreate</td>
<td>lvcreate</td>
</tr>
<tr>
<td>显示</td>
<td>pvdisplay</td>
<td>vgdisplay</td>
<td>lvdisplay</td>
</tr>
<tr>
<td>删除</td>
<td>pvremove</td>
<td>vgremove</td>
<td>lvremove</td>
</tr>
<tr>
<td>扩展</td>
<td></td>
<td>vgextend</td>
<td>lvextend</td>
</tr>
<tr>
<td>缩小</td>
<td></td>
<td>vgreduce</td>
<td>lvreduce</td>
</tr>
</tbody>
</table>
<h3 id="LVM逻辑卷管理实操"><a href="#LVM逻辑卷管理实操" class="headerlink" title="LVM逻辑卷管理实操"></a>LVM逻辑卷管理实操</h3><p><strong>1）安装逻辑卷管理软件，创建物理卷，并添加卷组</strong></p>
<p><strong>Step1：我们首先添加两块磁盘/dev/sdb和/dev/sdc，</strong>用来作为逻辑实验的环境，方法同RAID实验添加磁盘。</p>
<p><img src="https://i.loli.net/2019/06/09/5cfcded42d81c26718.jpg"></p>
<p><strong>Step2：:安装lvm逻辑卷管理软件，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># yum install -y lvm2</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfcdf114a77617673.jpg"></p>
<p><strong>Step3：对添加的两块磁盘（整盘）创建物理卷</strong>，这样这两块就可以被LVM进行管理，并有相关LVM管理参数。代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># pvcreate /dev/sdb /dev/sdc</span></span><br><span class="line">Physical volume <span class="string">"/dev/sdb"</span> successfully created.</span><br><span class="line">Physical volume <span class="string">"/dev/sdc"</span> successfully created.</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfcdf41673aa85499.jpg"></p>
<p><strong>Step4：创建卷组datastorage ，并将两块物理盘加入到新创建的卷组中</strong>，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># vgcreate datastorage /dev/sdb /dev/sdc</span></span><br><span class="line">Volume group <span class="string">"datastorage"</span> successfully created</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfcdf6d9e48941077.jpg"></p>
<p><strong>2）逻辑卷管理实操</strong></p>
<p><strong>Step1：创建出一个150MB的逻辑卷设备lv_data01，</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># lvcreate -n lv_data01 -L 150M datastorage </span></span><br><span class="line">Rounding up size to full physical extent 152.00 MiB</span><br><span class="line">Logical volume <span class="string">"lv_data01"</span> created.</span><br></pre></td></tr></table></figure>
<p><strong>注意：这里切割单位的问题。在对逻辑卷进行切割时有两种计量单位。第一种是以容量为单位，所使用的参数为-L。例如，使用-L 150M生成一个大小为150MB的逻辑卷。另外一种是以基本单元的个数为单位，所使用的参数为-l。每个基本单元的大小默认为4MB。例如，使用-l 37可以生成一个大小为37×4MB=148MB的逻辑卷。我们采用的第一种切割办法。</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdfa428bd573707.jpg"></p>
<p><strong>Step2：把创建的逻辑卷格式化为ext4文件系统格式，然后挂载到/home/data01下使用。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># mkfs.ext4 /dev/datastorage/lv_data01 </span></span><br><span class="line">mke2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=1024 (<span class="built_in">log</span>=0)</span><br><span class="line">Fragment size=1024 (<span class="built_in">log</span>=0)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">38912 inodes, 155648 blocks</span><br><span class="line">7782 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=1</span><br><span class="line">Maximum filesystem blocks=33816576</span><br><span class="line">19 block groups</span><br><span class="line">8192 blocks per group, 8192 fragments per group</span><br><span class="line">2048 inodes per group</span><br><span class="line">Superblock backups stored on blocks: </span><br><span class="line">8193, 24577, 40961, 57345, 73729</span><br><span class="line">Allocating group tables: <span class="keyword">done</span>                            </span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (4096 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span> </span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mkdir /home/data01 &amp;&amp; mount /dev/datastorage/lv_data01 /home/data01</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfcdfd71812b75693.jpg"></p>
<p><strong>Linux系统会把LVM中的逻辑卷设备存放在/dev设备目录中（实际上是做了一个符号链接），同时会以卷组的名称来建立一个目录，其中保存了逻辑卷的设备映射文件（即/dev/卷组名称/逻辑卷名称）。设置开机自动挂载的方式，同上面RAID实操，这里不再赘述。</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfcdff11e04972825.jpg"></p>
<p><strong>Step3：扩容逻辑卷lv_data01，在扩容前需要先卸载挂载点，否则数据会丢失。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 卸载挂载点</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># umount /home/data01/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩容到290MB</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># lvextend -L 290M /dev/datastorage/lv_data01 </span></span><br><span class="line">  Rounding size to boundary between physical extents: 292.00 MiB.</span><br><span class="line">  Size of logical volume datastorage/lv_data01 changed from 152.00 MiB (38 extents) to 292.00 MiB (73 extents).</span><br><span class="line">  Logical volume datastorage/lv_data01 successfully resized.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查磁盘完整性，并重置磁盘容量</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># e2fsck -f /dev/datastorage/lv_data01 </span></span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">/dev/datastorage/lv_data01: 11/38912 files (0.0% non-contiguous), 10567/155648 blocks</span><br><span class="line">[root@c7-test01 ~]<span class="comment"># resize2fs /dev/datastorage/lv_data01 </span></span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Resizing the filesystem on /dev/datastorage/lv_data01 to 299008 (1k) blocks.</span><br><span class="line">The filesystem on /dev/datastorage/lv_data01 is now 299008 blocks long.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新挂载磁盘，并查看状态</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mount /dev/datastorage/lv_data01 /home/data01</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfce0329b51717664.jpg"></p>
<p><strong>在前面我们的卷组是由两块硬盘设备共同组成的。用户在使用存储设备时感知不到设备底层的架构和布局，更不用关心底层是由多少块硬盘组成的，只要卷组中有足够的资源，就可以一直为逻辑卷扩容。</strong></p>
<p><strong>Step4：缩容逻辑卷lv_data01，在执行缩容操作前记得先把挂载点卸载掉，同时要先检查磁盘文件系统的完整性。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取消挂载点，并检查文件系统完整性</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># umount /home/data01/ &amp;&amp; e2fsck -f /dev/datastorage/lv_data01 </span></span><br><span class="line">e2fsck 1.42.9 (28-Dec-2013)</span><br><span class="line">Pass 1: Checking inodes, blocks, and sizes</span><br><span class="line">Pass 2: Checking directory structure</span><br><span class="line">Pass 3: Checking directory connectivity</span><br><span class="line">Pass 4: Checking reference counts</span><br><span class="line">Pass 5: Checking group summary information</span><br><span class="line">/dev/datastorage/lv_data01: 11/75776 files (0.0% non-contiguous), 15729/299008 blocks</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把逻辑卷缩小到120M</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># resize2fs /dev/datastorage/lv_data01 120M</span></span><br><span class="line">resize2fs 1.42.9 (28-Dec-2013)</span><br><span class="line">Resizing the filesystem on /dev/datastorage/lv_data01 to 122880 (1k) blocks.</span><br><span class="line">The filesystem on /dev/datastorage/lv_data01 is now 122880 blocks long.</span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># lvreduce -L 120M /dev/datastorage/lv_data01 </span></span><br><span class="line">  WARNING: Reducing active logical volume to 120.00 MiB.</span><br><span class="line">  THIS MAY DESTROY YOUR DATA (filesystem etc.)</span><br><span class="line">Do you really want to reduce datastorage/lv_data01? [y/n]: y</span><br><span class="line">  Size of logical volume datastorage/lv_data01 changed from 292.00 MiB (73 extents) to 120.00 MiB (30 extents).</span><br><span class="line">  Logical volume datastorage/lv_data01 successfully resized.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新挂载，并查看挂载状态</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># mount /dev/datastorage/lv_data01 /home/data01/</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfce086abf0d11068.jpg"></p>
<p><strong>相较于扩容逻辑卷，在对逻辑卷进行缩容操作时，其丢失数据的风险更大。所以在生产环境中执行相应操作时，一定要提前备份好数据。另外Linux系统规定，在对LVM逻辑卷进行缩容操作之前，要先检查文件系统的完整性（当然这也是为了保证我们的数据安全）。</strong></p>
<p><strong>Step5：创建快照卷，在创建之前我们往现有挂载目录写入一个测试文件。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入测试文件</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># echo "Welcome to kkutysllb.cn" &gt; /home/data01/redeme.txt</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># cat /home/data01/redeme.txt </span></span><br><span class="line">Welcome to kkutysllb.cn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建快照卷，使用-s 选项创建</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># lvcreate -L 120M -s -n lv_data01_snp /dev/datastorage/lv_data01</span></span><br><span class="line">  Logical volume <span class="string">"lv_data01_snp"</span> created.</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfce0b432b0b25609.jpg"></p>
<p>在逻辑卷lv_data01的挂载目录中创建一个100M的测试文件，可以看见快照卷的容量同步上升，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@c7-test01 ~]<span class="comment"># dd if=/dev/zero of=/home/data01/test_files bs=1M count=100</span></span><br><span class="line">100+0 records <span class="keyword">in</span></span><br><span class="line">100+0 records out</span><br><span class="line">104857600 bytes (105 MB) copied, 1.12679 s, 93.1 MB/s</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfce0f2b64cb41781.jpg"></p>
<p><strong>LVM的“快照卷”功能类似于虚拟机软件的还原时间点功能。</strong>例如，可以对某一个逻辑卷设备做一次快照，如果日后发现数据被改错了，就可以利用之前做好的快照卷进行覆盖还原。LVM的快照卷功能有两个特点：</p>
<ul>
<li><strong>快照卷的容量必须等同于逻辑卷的容量；</strong></li>
<li><strong>快照卷仅一次有效，一旦执行还原操作后则会被立即自动删除。</strong></li>
</ul>
<p><strong>Step6：校验快照卷的恢复效果，记得先取消逻辑卷lv_data01的挂载点。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取消挂载</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># umount /home/data01/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用快照卷lv_data01_snp对逻辑卷lv_data01进行还原</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># umount /home/data01/</span></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># lvconvert --merge /dev/datastorage/lv_data01_snp </span></span><br><span class="line">  Merging of volume datastorage/lv_data01_snp started.</span><br><span class="line">  datastorage/lv_data01: Merged: 30.56%</span><br><span class="line">  datastorage/lv_data01: Merged: 100.00%</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新挂载逻辑卷lv_data01</span></span><br><span class="line"></span><br><span class="line"> [root@c7-test01 ~]<span class="comment"># mount /dev/datastorage/lv_data01 /home/data01/</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/06/09/5cfce149ce3fb31332.jpg"></p>
<p><strong>使用快照卷还原后，原来创建的100M垃圾文件也就同步被清空了，同时快照卷只能使用一次，因此也会被系统回收。如下：</strong></p>
<p><img src="https://i.loli.net/2019/06/09/5cfce16a065f755843.jpg"></p>
<p><img src="https://i.loli.net/2019/06/09/5cfce1827171255801.jpg"></p>
<p><strong>Step7：删除逻辑卷，首先需要取消挂载点，然后按照逻辑卷—卷组—物理卷的顺序依次删除。</strong>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取消挂载</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># umount /home/data01/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除逻辑卷lv_data01</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># lvremove /dev/datastorage/lv_data01 </span></span><br><span class="line">Do you really want to remove active logical volume datastorage/lv_data01? [y/n]: y</span><br><span class="line">  Logical volume <span class="string">"lv_data01"</span> successfully removed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除卷组</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># vgremove datastorage </span></span><br><span class="line">  Volume group <span class="string">"datastorage"</span> successfully removed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除物理卷</span></span><br><span class="line"></span><br><span class="line">[root@c7-test01 ~]<span class="comment"># pvremove /dev/sdb /dev/sdc</span></span><br><span class="line">  Labels on physical volume <span class="string">"/dev/sdb"</span> successfully wiped.</span><br><span class="line">  Labels on physical volume <span class="string">"/dev/sdc"</span> successfully wiped.</span><br></pre></td></tr></table></figure>
<p>完成后，通过pvdisplay、vgdisplay、lvdisplay进行校验，如下：</p>
<p><img src="https://i.loli.net/2019/06/09/5cfce1bb34a0084086.jpg"></p>
<p><strong>至此，Linux原生的存储虚拟化介绍完毕，在后续KVM和OpenStack等开源技术实操时，还会用到Linux原生的存储虚拟化LVM，网络虚拟化vSwitch等实操，所以这里还需各位好好理解并掌握。</strong></p>

      
    </div>

    

    
    
    

    

    
      
    
	
	<div>
	
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
	
	</div>
	
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="kkutysllb 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="kkutysllb 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        



  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>kkutysllb</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://kkutysllb.cn/2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/" title="2019-06-09-Linux原生的存储虚拟化软RAID和LVM">https://kkutysllb.cn/2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/电信云/" rel="tag"><i class="fa fa-tag"></i> 电信云</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/07/2019-06-07-浅析5G-SBA服务网络架构/" rel="next" title="2019-06-07-浅析5G-SBA服务网络架构">
                <i class="fa fa-chevron-left"></i> 2019-06-07-浅析5G-SBA服务网络架构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/12/2019-06-12-网络虚拟化概述/" rel="prev" title="2019-06-12-网络虚拟化概述">
                2019-06-12-网络虚拟化概述 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MjY0Ni8xOTE5Mw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="kkutysllb">
            
              <p class="site-author-name" itemprop="name">kkutysllb</p>
              <p class="site-description motion-element" itemprop="description">容易走的路是下坡路<br>总是不经意间装个X得罪一票人</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/kkutysllb" title="GitHub &rarr; https://github.com/kkutysllb" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:linbrid772233@gmail.com" title="E-Mail &rarr; mailto:linbrid772233@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-e-mail"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/u/2243838583?is_all=1" title="Weibo &rarr; https://weibo.com/u/2243838583?is_all=1" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/tang-xi-yao-43/activities" title="Zhihu &rarr; https://www.zhihu.com/people/tang-xi-yao-43/activities" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i>Zhihu</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#RAID-技术"><span class="nav-number">1.</span> <span class="nav-text">RAID 技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-0"><span class="nav-number">1.1.</span> <span class="nav-text">RAID 0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-1"><span class="nav-number">1.2.</span> <span class="nav-text">RAID 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-3"><span class="nav-number">1.3.</span> <span class="nav-text">RAID 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-5"><span class="nav-number">1.4.</span> <span class="nav-text">RAID 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-6"><span class="nav-number">1.5.</span> <span class="nav-text">RAID 6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-10"><span class="nav-number">1.6.</span> <span class="nav-text">RAID 10</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RAID-50"><span class="nav-number">1.7.</span> <span class="nav-text">RAID 50</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用RAID级别的比较和应用场景"><span class="nav-number">1.8.</span> <span class="nav-text">常用RAID级别的比较和应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#虚拟机中的RAID实操"><span class="nav-number">1.9.</span> <span class="nav-text">虚拟机中的RAID实操</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LVM逻辑卷管理"><span class="nav-number">2.</span> <span class="nav-text">LVM逻辑卷管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LVM逻辑卷管理的原理浅析"><span class="nav-number">2.1.</span> <span class="nav-text">LVM逻辑卷管理的原理浅析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVM逻辑卷管理实操"><span class="nav-number">2.2.</span> <span class="nav-text">LVM逻辑卷管理实操</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kkutysllb</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">699k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">10:35</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  
    <script>
  window.livereOptions = {
    refer: '2019/06/09/2019-06-09-Linux原生的存储虚拟化软RAID和LVM/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
